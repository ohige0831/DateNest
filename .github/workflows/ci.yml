name: CI
on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  lint-ubuntu:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ruff
        run: |
          python -m pip install -U pip
          pip install "ruff==0.6.9"

      - id: ruff_lint
        name: Ruff (lint)
        continue-on-error: true
        run: |
          set -o pipefail
          python -m ruff check . --output-format=github | tee ruff_lint_ubuntu.log

      - id: ruff_fmt
        name: Ruff (format check)
        continue-on-error: true
        run: |
          set -o pipefail
          python -m ruff format --check . --diff | tee ruff_fmt_ubuntu.log

      - name: Upload ruff logs (ubuntu)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ruff-logs-ubuntu
          path: |
            ruff_lint_ubuntu.log
            ruff_fmt_ubuntu.log
          if-no-files-found: ignore

      - name: Fail if ruff failed (ubuntu)
        if: steps.ruff_lint.outcome == 'failure' || steps.ruff_fmt.outcome == 'failure'
        run: exit 1

  lint-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install ruff
        shell: pwsh
        run: |
          python -m pip install -U pip
          pip install "ruff==0.6.9"

      - id: ruff_lint_win
        name: Ruff (lint)
        shell: pwsh
        continue-on-error: true
        run: |
          python -m ruff check . --output-format=github *>&1 | Tee-Object -FilePath ruff_lint_windows.log

      - id: ruff_fmt_win
        name: Ruff (format check)
        shell: pwsh
        continue-on-error: true
        run: |
          python -m ruff format --check . --diff *>&1 | Tee-Object -FilePath ruff_fmt_windows.log

      - name: Upload ruff logs (windows)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ruff-logs-windows
          path: |
            ruff_lint_windows.log
            ruff_fmt_windows.log
          if-no-files-found: ignore

      - name: Fail if ruff failed (windows)
        if: steps.ruff_lint_win.outcome == 'failure' || steps.ruff_fmt_win.outcome == 'failure'
        run: exit 1
