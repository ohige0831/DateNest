# 🦅 DateNest 仕様書

## 1. コンセプト

-   完全ローカル運用（ネットワーク同期不要、セキュリティリスク低）
-   解析結果画像・CSVを **「タグ＋条件＋出自」** で整理\
-   **複数人利用**：誰が付けたタグかを分離保持、差分をZIPでやり取りしてマージ可能\
-   Eagleライクな **タイルビュー＋パネルビューア** で直感的に良否判断

------------------------------------------------------------------------

## 2. データ構造（SQLiteベース）

### 2.1 画像

``` sql
images(id, rel_path, sha256, created_at, run_id, parent_sha256)
```

### 2.2 解析ラン（出自の記録）

``` sql
runs(id, operator_username, tool_name, tool_version, pipeline_hash, params_json, ran_at)
```

### 2.3 ユーザー

``` sql
users(id, username, display_name)
```

### 2.4 タグ

``` sql
tags(id, name, category, description)
```

### 2.5 ユーザー別注釈

``` sql
annotations(id, image_id, tag_id, user_id, created_at, is_deleted)
```

### 2.6 良否投票（オプション）

``` sql
quality_votes(id, image_id, user_id, label, score, created_at)
```

### 2.7 添付ファイル（CSV等）

``` sql
attachments(id, image_id, kind, rel_path, sha256, created_at)
```

### 2.8 数値メトリクス（CSVから抽出）

``` sql
metrics(image_id PRIMARY KEY, json)
```

### 2.9 authoritative（任意）

``` sql
authoritative(parent_sha256, run_id)
```

------------------------------------------------------------------------

## 3. エクスポート／インポート

### エクスポート

-   ZIP形式\
-   `files/`：画像・CSV実体\
-   `manifest.json`：runs, images, annotations, quality_votes, metrics\
-   差分抽出は `created_at > last_sync_at`

### インポート

-   `sha256` で重複回避、`run_id` 単位で成果物区別\
-   タグ/投票はユーザーごとにマージ（衝突なし）\
-   削除（is_deleted=1）は伝搬

------------------------------------------------------------------------

## 4. UI（PySide6ベース）

### 4.1 画面構成

-   上：検索バー＋フィルタ（タグ/日付/ユーザー/メトリクス条件）\
-   左：ユーザーフィルタ（自分のみ/全員/合意表示）\
-   中：タイルビュー（サムネイル一覧）\
-   右：詳細パネル（タブ切替式：タグ編集 / CSVプレビュー /
    メトリクス要約）\
-   下：ステータスバー（件数、処理速度、ログインユーザー）

### 4.2 タイル表示

-   サムネ縮小キャッシュで高速描画\
-   縁色 = run（誰がどの解析か）\
-   角ドット = 自分の良否投票\
-   ツールチップ = 条件要約（タグ・メトリクス・operator/version）

### 4.3 操作系

-   ホットキー：`1=良, 2=保留, 3=悪`\
-   複数選択 → 一括タグ付与・一括投票\
-   差分ZIPのエクスポート/インポートボタン

------------------------------------------------------------------------

## 5. 自動提案（オプション）

### 特徴量

-   画像特徴（シャープネス、露出、コントラスト、ノイズ）\
-   CSVメトリクス（粒子数、直径分布、ROI率、重複率、S/N比など）

### 判定ロジック

-   ルールベーススコア → 良/保留/悪を提案\
-   理由を保存（例：「露出飽和8%」「外れ粒径20%」）\
-   信頼度バーを表示

------------------------------------------------------------------------

## 6. 運用フロー

1.  各PCに DateNest 導入（ユーザー名登録）\
2.  解析結果（PNG+CSV）保存時にDB登録（run_id付き）\
3.  サムネ生成・自動提案\
4.  人がホットキーやタグ入力で確定\
5.  必要に応じて差分ZIPを持ち帰り/受け渡し\
6.  インポートでマージ（ユーザーごとに記録保持）\
7.  管理者が authoritative run を指定（必要なら）

------------------------------------------------------------------------

## 7. この仕様の強み

-   🔄 **衝突しないマージ**（ユーザー別注釈＋run分離）\
-   🧑‍🔬 **出自の明確化**（誰・どの条件・どの解析バージョンか）\
-   🏷 **タグ付けの柔軟性**（最大5人、削除伝搬、合意ルール）\
-   🖼 **直感的なタイルUI**（一目で良否判断）\
-   📦 **差分ZIPで軽量共有**（ネット同期不要）\
-   🤖 **自動提案で省力化**（画像＋CSVメトリクスを活用）
